'use client'

export const dynamic = 'force-dynamic'

import { useState, useRef, useEffect } from 'react'
import Link from 'next/link'
import { Send, Bot, User, Sparkles, ChevronDown, FileCode, Loader2, Trash2, Database, Plus, X, Upload, Github, Globe, FileText, Cpu, CheckCircle, MessageSquare, Edit2, MoreVertical, Copy, RotateCcw, Download, Search } from 'lucide-react'
import { query, queryStream, listSources, ingestPDF, ingestGitHub, ingestURL, Source, Citation, getModelSettings, setModelSettings, ModelConfig, StreamEvent, getAvailableProviders, WebSearchResult, clearConversation } from '@/lib/api'
import AgentThinking from '@/components/AgentThinking'
import WebSearchResults from '@/components/WebSearchResults'
import ToolUsage from '@/components/ToolUsage'
import { sessionManager, ChatSession } from '@/lib/sessionManager'
import { exportToJSON, exportToMarkdown, exportToPDF } from '@/lib/utils/export'
import toast from 'react-hot-toast'
import ReactMarkdown from 'react-markdown'
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter'
import { vscDarkPlus } from 'react-syntax-highlighter/dist/esm/styles/prism'

export interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  citations?: Citation[]
  timestamp: Date
  error?: boolean
  errorMessage?: string
  webSearchResults?: WebSearchResult[]
  plan?: {
    steps?: Array<{ type: string; reason: string }>
    requires_tools?: boolean
  }
  toolsUsed?: Array<{ name: string; result?: any }>
}

export default function ChatPage() {
  const [messages, setMessages] = useState<Message[]>([])
  const [input, setInput] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [sessionId, setSessionId] = useState<string | null>(null)
  const [sources, setSources] = useState<Source[]>([])
  const [sourcesLoading, setSourcesLoading] = useState(true)
  const [showUploadPanel, setShowUploadPanel] = useState(false)
  const [uploadType, setUploadType] = useState<'pdf' | 'github' | 'url' | null>(null)
  const [uploading, setUploading] = useState(false)
  const [urlInput, setUrlInput] = useState('')
  const [githubUrl, setGithubUrl] = useState('')
  const [githubBranch, setGithubBranch] = useState('main')
  const [modelConfig, setModelConfig] = useState<ModelConfig | null>(null)
  const [showModelSelector, setShowModelSelector] = useState(false)
  const [switchingModel, setSwitchingModel] = useState(false)
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null)
  const [sessions, setSessions] = useState<ChatSession[]>([])
  const [showSessionsPanel, setShowSessionsPanel] = useState(false)
  const [editingSessionId, setEditingSessionId] = useState<string | null>(null)
  const [editingSessionName, setEditingSessionName] = useState('')
  const [editingMessageId, setEditingMessageId] = useState<string | null>(null)
  const [editingMessageContent, setEditingMessageContent] = useState('')
  const [regeneratingMessageId, setRegeneratingMessageId] = useState<string | null>(null)
  const [showExportMenu, setShowExportMenu] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')
  const [showSearch, setShowSearch] = useState(false)
  const [selectedSourceFilter, setSelectedSourceFilter] = useState<string | null>(null)
  const [useStreaming, setUseStreaming] = useState(true)
  const [useAgentic, setUseAgentic] = useState(true)
  const [useWebSearch, setUseWebSearch] = useState(false)
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const exportMenuRef = useRef<HTMLDivElement>(null)
  const searchInputRef = useRef<HTMLInputElement>(null)
  const inputRef = useRef<HTMLTextAreaElement>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const modelSelectorRef = useRef<HTMLDivElement>(null)
  const sessionsPanelRef = useRef<HTMLDivElement>(null)

  const MODEL_INFO = {
    gemini: {
      name: 'Gemini 2.5',
      icon: 'âœ¨',
      models: [
        { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash' },
        { id: 'gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite' },
        { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash' },
      ]
    },
    groq: {
      name: 'LLaMA 3.1',
      icon: 'ðŸ¦™',
      models: [
        { id: 'llama-3.1-70b-versatile', name: 'LLaMA 3.1 70B' },
        { id: 'llama-3.1-8b-instant', name: 'LLaMA 3.1 8B' },
        { id: 'mixtral-8x7b-32768', name: 'Mixtral 8x7B' },
      ]
    }
  }

  useEffect(() => {
    fetchSources()
    loadModelConfig()
    loadSessions()
    // Create initial session if none exists
    const allSessions = sessionManager.getAllSessions()
    if (allSessions.length === 0) {
      const newSession = sessionManager.createSession()
      setCurrentSessionId(newSession.id)
      setSessions([newSession])
    } else {
      setCurrentSessionId(allSessions[0].id)
      setSessions(allSessions)
      loadSessionData(allSessions[0].id)
    }
  }, [])

  useEffect(() => {
    // Save current session when messages or sessionId changes
    if (currentSessionId) {
      sessionManager.updateSession(currentSessionId, {
        messages,
        sessionId
      })
      setSessions(sessionManager.getAllSessions())
    }
  }, [messages, sessionId, currentSessionId])

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (sessionsPanelRef.current && !sessionsPanelRef.current.contains(event.target as Node)) {
        setShowSessionsPanel(false)
      }
      if (exportMenuRef.current && !exportMenuRef.current.contains(event.target as Node)) {
        setShowExportMenu(false)
      }
    }
    if (showSessionsPanel || showExportMenu) {
      document.addEventListener('mousedown', handleClickOutside)
    }
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [showSessionsPanel, showExportMenu])

  const handleExport = (format: 'json' | 'markdown' | 'pdf') => {
    if (messages.length === 0) {
      toast.error('No messages to export')
      return
    }
    
    const sessionName = currentSessionId 
      ? sessions.find(s => s.id === currentSessionId)?.name || 'Chat'
      : 'Chat'
    
    try {
      switch (format) {
        case 'json':
          exportToJSON(messages, sessionName)
          toast.success('Exported as JSON')
          break
        case 'markdown':
          exportToMarkdown(messages, sessionName)
          toast.success('Exported as Markdown')
          break
        case 'pdf':
          exportToPDF(messages, sessionName)
          toast.success('Opening PDF preview...')
          break
      }
      setShowExportMenu(false)
    } catch (error) {
      toast.error('Failed to export chat')
      console.error(error)
    }
  }

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (modelSelectorRef.current && !modelSelectorRef.current.contains(event.target as Node)) {
        setShowModelSelector(false)
      }
    }
    if (showModelSelector) {
      document.addEventListener('mousedown', handleClickOutside)
    }
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [showModelSelector])

  const loadModelConfig = async () => {
    try {
      const config = await getModelSettings()
      setModelConfig(config)
    } catch (error) {
      console.error('Failed to load model config:', error)
    }
  }

  const loadSessions = () => {
    const allSessions = sessionManager.getAllSessions()
    setSessions(allSessions)
  }

  const loadSessionData = (sessionId: string) => {
    const session = sessionManager.getSession(sessionId)
    if (session) {
      setMessages(session.messages || [])
      setSessionId(session.sessionId)
    }
  }

  const switchSession = (sessionId: string) => {
    // Save current session before switching
    if (currentSessionId) {
      sessionManager.updateSession(currentSessionId, {
        messages,
        sessionId
      })
    }
    setCurrentSessionId(sessionId)
    loadSessionData(sessionId)
    setShowSessionsPanel(false)
  }

  const createNewSession = () => {
    const newSession = sessionManager.createSession()
    setCurrentSessionId(newSession.id)
    setMessages([])
    setSessionId(null)
    loadSessions()
    setShowSessionsPanel(false)
    toast.success('New chat created')
  }

  const deleteSession = (sessionId: string) => {
    if (sessions.length === 1) {
      toast.error('Cannot delete the last session')
      return
    }
    sessionManager.deleteSession(sessionId)
    loadSessions()
    if (currentSessionId === sessionId) {
      const remaining = sessions.filter(s => s.id !== sessionId)
      if (remaining.length > 0) {
        switchSession(remaining[0].id)
      }
    }
    toast.success('Session deleted')
  }

  const startEditingSession = (sessionId: string) => {
    const session = sessionManager.getSession(sessionId)
    if (session) {
      setEditingSessionId(sessionId)
      setEditingSessionName(session.name)
    }
  }

  const saveSessionName = () => {
    if (editingSessionId && editingSessionName.trim()) {
      sessionManager.renameSession(editingSessionId, editingSessionName.trim())
      loadSessions()
      setEditingSessionId(null)
      setEditingSessionName('')
      toast.success('Session renamed')
    }
  }

  const handleSwitchModel = async (provider: string, model?: string) => {
    setSwitchingModel(true)
    try {
      const result = await setModelSettings(provider, model)
      setModelConfig(result)
      setShowModelSelector(false)
      toast.success(`Switched to ${MODEL_INFO[provider as keyof typeof MODEL_INFO]?.name || provider}`)
    } catch (error: any) {
      toast.error(error.message || 'Failed to switch model')
    } finally {
      setSwitchingModel(false)
    }
  }

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Don't trigger shortcuts when typing in inputs/textarea
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
        // Allow Ctrl/Cmd + Enter to send
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault()
          handleSubmit()
          return
        }
        // Allow Ctrl/Cmd + K to focus input (if not already focused)
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          if (document.activeElement !== inputRef.current) {
            e.preventDefault()
            inputRef.current?.focus()
          }
          return
        }
        return
      }

      // Global shortcuts
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault()
        inputRef.current?.focus()
      }
      
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault()
        createNewSession()
      }
      
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault()
        if (messages.length > 0) {
          setShowExportMenu(true)
        }
      }
      
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault()
        setShowSearch(true)
        setTimeout(() => searchInputRef.current?.focus(), 0)
      }
      
      if (e.key === 'Escape') {
        setShowSessionsPanel(false)
        setShowModelSelector(false)
        setShowExportMenu(false)
        setShowUploadPanel(false)
        setShowSearch(false)
        setSearchQuery('')
        if (editingMessageId) {
          setEditingMessageId(null)
          setEditingMessageContent('')
        }
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [messages.length, editingMessageId])

  const fetchSources = async () => {
    try {
      const data = await listSources()
      setSources(data)
    } catch (error) {
      console.error('Failed to fetch sources:', error)
    } finally {
      setSourcesLoading(false)
    }
  }

  const handleSubmit = async (e?: React.FormEvent, customQuestion?: string) => {
    e?.preventDefault()
    const question = customQuestion || input.trim()
    if (!question || isLoading) return

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: question,
      timestamp: new Date(),
    }

    setMessages(prev => [...prev, userMessage])
    if (!customQuestion) {
      setInput('')
    }
    setIsLoading(true)

    // Create placeholder assistant message
    const assistantMessageId = (Date.now() + 1).toString()
    const assistantMessage: Message = {
      id: assistantMessageId,
      role: 'assistant',
      content: '',
      citations: [],
      timestamp: new Date(),
    }
    setMessages(prev => [...prev, assistantMessage])

    if (useStreaming) {
      // Use streaming with agentic features
      let accumulatedContent = ''
      let webSearchResults: WebSearchResult[] = []
      let plan: { steps?: Array<{ type: string; reason: string }>; requires_tools?: boolean } | undefined = undefined
      let toolsUsed: Array<{ name: string; result?: any }> = []
      
      await queryStream(
        question,
        sessionId || undefined,
        (event: StreamEvent) => {
          if (event.type === 'chunk') {
            accumulatedContent += event.content || ''
            setMessages(prev => prev.map(msg => 
              msg.id === assistantMessageId 
                ? { ...msg, content: accumulatedContent }
                : msg
            ))
          } else if (event.type === 'web_search') {
            webSearchResults = event.web_search || []
            setMessages(prev => prev.map(msg => 
              msg.id === assistantMessageId 
                ? { ...msg, webSearchResults }
                : msg
            ))
          } else if (event.type === 'done') {
            setSessionId(event.session_id || sessionId || null)
            setMessages(prev => prev.map(msg => 
              msg.id === assistantMessageId 
                ? { 
                    ...msg, 
                    citations: event.citations || [],
                    ...(plan ? { plan } : {}),
                    ...(toolsUsed.length > 0 ? { toolsUsed } : {})
                  }
                : msg
            ))
            setIsLoading(false)
          } else if (event.type === 'error') {
            setMessages(prev => prev.map(msg => 
              msg.id === assistantMessageId 
                ? { ...msg, error: true, errorMessage: event.error || 'Unknown error', content: '' }
                : msg
            ))
            setIsLoading(false)
            toast.error(event.error || 'Unknown error')
          }
        },
        5,
        selectedSourceFilter || undefined,
        useAgentic,
        useWebSearch
      )
    } else {
      // Use regular query
      try {
        const response = await query(
          question, 
          sessionId || undefined, 
          5, 
          selectedSourceFilter || undefined,
          useAgentic,
          useWebSearch
        )
        setSessionId(response.session_id)

        setMessages(prev => prev.map(msg => 
          msg.id === assistantMessageId 
            ? { ...msg, content: response.answer, citations: response.citations }
            : msg
        ))
      } catch (error: any) {
        setMessages(prev => prev.map(msg => 
          msg.id === assistantMessageId 
            ? { ...msg, error: true, errorMessage: error.message || 'Failed to get response', content: '' }
            : msg
        ))
        toast.error(error.message || 'Failed to get response')
        console.error(error)
      } finally {
        setIsLoading(false)
      }
    }
  }

  const handleRetry = async (messageId: string) => {
    const messageIndex = messages.findIndex(m => m.id === messageId)
    if (messageIndex === -1 || messageIndex === 0) return

    const userMessage = messages[messageIndex - 1]
    if (userMessage.role !== 'user') return

    // Remove error message
    const updatedMessages = messages.slice(0, messageIndex)
    setMessages(updatedMessages)

    // Retry the query
    setIsLoading(true)
    try {
      const response = await query(userMessage.content, sessionId || undefined, 5, selectedSourceFilter || undefined)
      setSessionId(response.session_id)

      const assistantMessage: Message = {
        id: Date.now().toString(),
        role: 'assistant',
        content: response.answer,
        citations: response.citations,
        timestamp: new Date(),
      }

      setMessages(prev => [...prev, assistantMessage])
    } catch (error: any) {
      const errorMessage: Message = {
        id: Date.now().toString(),
        role: 'assistant',
        content: '',
        timestamp: new Date(),
        error: true,
        errorMessage: error.message || 'Failed to get response'
      }
      setMessages(prev => [...prev, errorMessage])
      toast.error(error.message || 'Failed to get response')
    } finally {
      setIsLoading(false)
    }
  }

  const handleEditMessage = (messageId: string) => {
    const message = messages.find(m => m.id === messageId)
    if (message && message.role === 'user') {
      setEditingMessageId(messageId)
      setEditingMessageContent(message.content)
    }
  }

  const handleSaveEdit = () => {
    if (!editingMessageId || !editingMessageContent.trim()) return
    
    const messageIndex = messages.findIndex(m => m.id === editingMessageId)
    if (messageIndex === -1) return

    // Update the message
    const updatedMessages = [...messages]
    updatedMessages[messageIndex] = {
      ...updatedMessages[messageIndex],
      content: editingMessageContent.trim()
    }

    // Remove all messages after this one (to regenerate from this point)
    const messagesToKeep = updatedMessages.slice(0, messageIndex + 1)
    setMessages(messagesToKeep)

    // Re-send the edited message
    setEditingMessageId(null)
    setEditingMessageContent('')
    handleSubmit(undefined, editingMessageContent.trim())
  }

  const handleDeleteMessage = (messageId: string) => {
    const messageIndex = messages.findIndex(m => m.id === messageId)
    if (messageIndex === -1) return

    // If deleting a user message, also remove the assistant response after it
    const message = messages[messageIndex]
    let messagesToRemove = 1
    if (message.role === 'user' && messageIndex + 1 < messages.length) {
      const nextMessage = messages[messageIndex + 1]
      if (nextMessage.role === 'assistant') {
        messagesToRemove = 2
      }
    }

    const updatedMessages = messages.filter((_, index) => {
      if (message.role === 'user') {
        return index < messageIndex || index >= messageIndex + messagesToRemove
      }
      return index !== messageIndex
    })

    setMessages(updatedMessages)
    toast.success('Message deleted')
  }

  const handleRegenerate = async (messageId: string) => {
    const messageIndex = messages.findIndex(m => m.id === messageId)
    if (messageIndex === -1 || messageIndex === 0) return

    const userMessage = messages[messageIndex - 1]
    if (userMessage.role !== 'user') return

    setRegeneratingMessageId(messageId)
    
    // Remove the assistant message
    const messagesToKeep = messages.slice(0, messageIndex)
    setMessages(messagesToKeep)

    // Re-send the user's question
    try {
      const response = await query(userMessage.content, sessionId || undefined)
      setSessionId(response.session_id)

      const assistantMessage: Message = {
        id: Date.now().toString(),
        role: 'assistant',
        content: response.answer,
        citations: response.citations,
        timestamp: new Date(),
      }

      setMessages(prev => [...prev, assistantMessage])
    } catch (error: any) {
      toast.error(error.message || 'Failed to regenerate response')
    } finally {
      setRegeneratingMessageId(null)
    }
  }

  const handleCopyMessage = async (content: string) => {
    try {
      await navigator.clipboard.writeText(content)
      toast.success('Copied to clipboard')
    } catch (error) {
      toast.error('Failed to copy')
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSubmit()
    }
  }

  const clearChat = async () => {
    if (sessionId) {
      try {
        await clearConversation(sessionId)
      } catch (error) {
        console.error('Failed to clear conversation on server:', error)
      }
    }
    setMessages([])
    setSessionId(null)
    if (currentSessionId) {
      sessionManager.updateSession(currentSessionId, {
        messages: [],
        sessionId: null
      })
    }
    toast.success('Chat cleared')
  }

  const adjustTextareaHeight = () => {
    if (inputRef.current) {
      inputRef.current.style.height = 'auto'
      inputRef.current.style.height = Math.min(inputRef.current.scrollHeight, 160) + 'px'
    }
  }

  // Upload handlers
  const handlePDFUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    if (!file.name.endsWith('.pdf')) {
      toast.error('Please select a PDF file')
      return
    }

    setUploading(true)
    try {
      const result = await ingestPDF(file)
      toast.success(`Uploaded ${file.name} (${result.chunks_created} chunks)`)
      fetchSources()
      setShowUploadPanel(false)
      setUploadType(null)
    } catch (error: any) {
      toast.error(error.message || 'Failed to upload PDF')
    } finally {
      setUploading(false)
      if (fileInputRef.current) fileInputRef.current.value = ''
    }
  }

  const handleURLSubmit = async () => {
    if (!urlInput.trim()) return

    setUploading(true)
    try {
      const result = await ingestURL(urlInput.trim())
      toast.success(`Added URL (${result.chunks_created} chunks)`)
      fetchSources()
      setUrlInput('')
      setShowUploadPanel(false)
      setUploadType(null)
    } catch (error: any) {
      toast.error(error.message || 'Failed to add URL')
    } finally {
      setUploading(false)
    }
  }

  const handleGitHubSubmit = async () => {
    if (!githubUrl.trim()) return

    setUploading(true)
    try {
      const result = await ingestGitHub(githubUrl.trim(), githubBranch)
      toast.success(`Added repo (${result.chunks_created} chunks)`)
      fetchSources()
      setGithubUrl('')
      setGithubBranch('main')
      setShowUploadPanel(false)
      setUploadType(null)
    } catch (error: any) {
      toast.error(error.message || 'Failed to add repository')
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="flex flex-col h-screen">
      {/* Header */}
      <header className="border-b border-[rgba(255,255,255,0.08)] bg-[#0a0a0f]/80 backdrop-blur-xl p-4">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3 flex-1 min-w-0">
            <button
              onClick={() => setShowSessionsPanel(!showSessionsPanel)}
              className="btn-ghost flex items-center gap-2 text-sm flex-shrink-0"
              title="Chat sessions"
            >
              <MessageSquare className="w-4 h-4" />
              <span className="hidden sm:inline">Sessions</span>
            </button>
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
              <Bot className="w-5 h-5 text-white" />
            </div>
            <div className="min-w-0 flex-1">
              <h1 className="font-semibold truncate">
                {currentSessionId ? sessions.find(s => s.id === currentSessionId)?.name || 'Chat' : 'Chat'}
              </h1>
              <p className="text-xs text-[#64748b] truncate">
                {sourcesLoading ? 'Loading...' : `${sources.length} source${sources.length !== 1 ? 's' : ''} loaded`}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2 flex-shrink-0">
            {/* Model Selector */}
            <div className="relative" ref={modelSelectorRef}>
              <button
                onClick={() => setShowModelSelector(!showModelSelector)}
                className="btn-ghost flex items-center gap-2 text-sm"
                title="Change model"
              >
                <Cpu className="w-4 h-4" />
                {modelConfig ? (
                  <span className="hidden sm:inline">
                    {MODEL_INFO[modelConfig.provider as keyof typeof MODEL_INFO]?.icon} {modelConfig.model.split('-')[0]}
                  </span>
                ) : (
                  <span className="hidden sm:inline">Model</span>
                )}
                <ChevronDown className={`w-4 h-4 transition-transform ${showModelSelector ? 'rotate-180' : ''}`} />
              </button>

              {showModelSelector && (
                <div className="absolute right-0 top-full mt-2 w-64 bg-[#15151f] border border-[rgba(255,255,255,0.1)] rounded-xl shadow-xl z-50 overflow-hidden">
                  <div className="p-2">
                    {modelConfig && Object.entries(MODEL_INFO).map(([key, info]) => {
                      const isActive = modelConfig.provider === key
                      const isAvailable = modelConfig.available_providers.includes(key)

                      return (
                        <div key={key}>
                          <button
                            onClick={() => isAvailable && !isActive && handleSwitchModel(key)}
                            disabled={!isAvailable || switchingModel}
                            className={`w-full p-3 rounded-lg text-left transition-all mb-1 ${
                              isActive
                                ? 'bg-indigo-500/20 border border-indigo-500/50'
                                : isAvailable
                                ? 'hover:bg-[rgba(255,255,255,0.05)] border border-transparent'
                                : 'opacity-50 cursor-not-allowed'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span>{info.icon}</span>
                                <span className="font-medium text-sm">{info.name}</span>
                              </div>
                              {isActive && <CheckCircle className="w-4 h-4 text-indigo-400" />}
                            </div>
                          </button>
                          {isActive && (
                            <div className="pl-4 pr-2 pb-2 space-y-1">
                              {info.models.map((model) => (
                                <button
                                  key={model.id}
                                  onClick={() => handleSwitchModel(key, model.id)}
                                  disabled={switchingModel || modelConfig.model === model.id}
                                  className={`w-full p-2 rounded text-left text-xs transition-all ${
                                    modelConfig.model === model.id
                                      ? 'bg-indigo-500/10 text-indigo-400'
                                      : 'hover:bg-[rgba(255,255,255,0.03)] text-[#94a3b8]'
                                  }`}
                                >
                                  {model.name}
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </div>
                </div>
              )}
            </div>

            {messages.length > 0 && (
              <>
                <button
                  onClick={() => {
                    setShowSearch(!showSearch)
                    if (!showSearch) {
                      setTimeout(() => searchInputRef.current?.focus(), 0)
                    } else {
                      setSearchQuery('')
                    }
                  }}
                  className="btn-ghost flex items-center gap-2"
                  title="Search messages (Ctrl/Cmd + F)"
                >
                  <Search className="w-4 h-4" />
                  <span className="hidden sm:inline">Search</span>
                </button>
                {sources.length > 0 && (
                  <div className="relative">
                    <select
                      value={selectedSourceFilter || ''}
                      onChange={(e) => setSelectedSourceFilter(e.target.value || null)}
                      className="btn-ghost text-sm appearance-none pr-8 cursor-pointer"
                      title="Filter by source"
                    >
                      <option value="">All Sources</option>
                      {sources.map((source) => (
                        <option key={source.id} value={source.id}>
                          {source.name}
                        </option>
                      ))}
                    </select>
                    {selectedSourceFilter && (
                      <button
                        onClick={() => setSelectedSourceFilter(null)}
                        className="absolute right-1 top-1/2 -translate-y-1/2 p-1 hover:bg-[rgba(255,255,255,0.1)] rounded"
                        title="Clear filter"
                      >
                        <X className="w-3 h-3" />
                      </button>
                    )}
                  </div>
                )}
                <div className="flex items-center gap-2">
                  <label className="flex items-center gap-2 text-sm cursor-pointer">
                    <input
                      type="checkbox"
                      checked={useAgentic}
                      onChange={(e) => setUseAgentic(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <span className="hidden sm:inline">Agentic</span>
                  </label>
                  <label className="flex items-center gap-2 text-sm cursor-pointer">
                    <input
                      type="checkbox"
                      checked={useWebSearch}
                      onChange={(e) => setUseWebSearch(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <span className="hidden sm:inline">Web Search</span>
                  </label>
                </div>
                <div className="relative" ref={exportMenuRef}>
                  <button
                    onClick={() => setShowExportMenu(!showExportMenu)}
                    className="btn-ghost flex items-center gap-2"
                    title="Export chat"
                  >
                    <Download className="w-4 h-4" />
                    <span className="hidden sm:inline">Export</span>
                  </button>
                  {showExportMenu && (
                    <div className="absolute right-0 top-full mt-2 w-48 bg-[#15151f] border border-[rgba(255,255,255,0.1)] rounded-xl shadow-xl z-50 overflow-hidden">
                      <button
                        onClick={() => handleExport('json')}
                        className="w-full px-4 py-2 text-left hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm"
                      >
                        Export as JSON
                      </button>
                      <button
                        onClick={() => handleExport('markdown')}
                        className="w-full px-4 py-2 text-left hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm"
                      >
                        Export as Markdown
                      </button>
                      <button
                        onClick={() => handleExport('pdf')}
                        className="w-full px-4 py-2 text-left hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm"
                      >
                        Export as PDF
                      </button>
                    </div>
                  )}
                </div>
                <button
                  onClick={clearChat}
                  className="btn-ghost flex items-center gap-2 text-red-400 hover:text-red-300"
                >
                  <Trash2 className="w-4 h-4" />
                  Clear
                </button>
              </>
            )}
          </div>
        </div>
      </header>

      {/* Sessions Panel */}
      {showSessionsPanel && (
        <div className="absolute left-0 top-0 bottom-0 w-80 bg-[#0a0a0f] border-r border-[rgba(255,255,255,0.08)] z-40 flex flex-col" ref={sessionsPanelRef}>
          <div className="p-4 border-b border-[rgba(255,255,255,0.08)]">
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-semibold">Chat Sessions</h2>
              <button
                onClick={() => setShowSessionsPanel(false)}
                className="text-[#64748b] hover:text-white"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            <button
              onClick={createNewSession}
              className="btn-primary w-full flex items-center justify-center gap-2"
            >
              <Plus className="w-4 h-4" />
              New Chat
            </button>
          </div>
          <div className="flex-1 overflow-y-auto p-2">
            <div className="space-y-1">
              {sessions.map((session) => (
                <div
                  key={session.id}
                  className={`group relative p-3 rounded-lg cursor-pointer transition-all ${
                    currentSessionId === session.id
                      ? 'bg-indigo-500/20 border border-indigo-500/50'
                      : 'hover:bg-[rgba(255,255,255,0.05)] border border-transparent'
                  }`}
                  onClick={() => switchSession(session.id)}
                >
                  {editingSessionId === session.id ? (
                    <div className="flex items-center gap-2">
                      <input
                        type="text"
                        value={editingSessionName}
                        onChange={(e) => setEditingSessionName(e.target.value)}
                        onBlur={saveSessionName}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') saveSessionName()
                          if (e.key === 'Escape') {
                            setEditingSessionId(null)
                            setEditingSessionName('')
                          }
                        }}
                        className="flex-1 bg-[#15151f] border border-indigo-500/50 rounded px-2 py-1 text-sm text-white outline-none"
                        autoFocus
                      />
                    </div>
                  ) : (
                    <>
                      <div className="flex items-center gap-2 mb-1">
                        <MessageSquare className="w-4 h-4 text-[#64748b]" />
                        <span className="font-medium text-sm truncate flex-1">{session.name}</span>
                      </div>
                      <p className="text-xs text-[#64748b]">
                        {new Date(session.updatedAt).toLocaleDateString()} â€¢ {session.messages.length} messages
                      </p>
                      <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            startEditingSession(session.id)
                          }}
                          className="p-1 rounded hover:bg-[rgba(255,255,255,0.1)]"
                          title="Rename"
                        >
                          <Edit2 className="w-3 h-3" />
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            if (confirm('Delete this chat session?')) {
                              deleteSession(session.id)
                            }
                          }}
                          className="p-1 rounded hover:bg-red-500/20 text-red-400"
                          title="Delete"
                        >
                          <Trash2 className="w-3 h-3" />
                        </button>
                      </div>
                    </>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Search Bar */}
      {showSearch && messages.length > 0 && (
        <div className="border-b border-[rgba(255,255,255,0.08)] bg-[#0a0a0f]/80 backdrop-blur-xl p-3">
          <div className="max-w-4xl mx-auto flex items-center gap-2">
            <Search className="w-4 h-4 text-[#64748b]" />
            <input
              ref={searchInputRef}
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search messages..."
              className="flex-1 bg-[#15151f] border border-[rgba(255,255,255,0.1)] rounded-lg px-3 py-2 text-sm text-white placeholder-[#64748b] focus:border-indigo-500 outline-none"
            />
            <button
              onClick={() => {
                setShowSearch(false)
                setSearchQuery('')
              }}
              className="text-[#64748b] hover:text-white"
            >
              <X className="w-4 h-4" />
            </button>
          </div>
          {searchQuery && (
            <div className="max-w-4xl mx-auto mt-2 text-xs text-[#64748b]">
              Found {messages.filter(m => 
                m.content.toLowerCase().includes(searchQuery.toLowerCase())
              ).length} message(s)
            </div>
          )}
        </div>
      )}

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 md:p-6">
        <div className="max-w-4xl mx-auto">
          {messages.length === 0 ? (
            <WelcomeScreen sources={sources} sourcesLoading={sourcesLoading} onAddSource={() => setShowUploadPanel(true)} />
          ) : (
            <div className="space-y-6">
              {messages
                .filter(message => 
                  !searchQuery || 
                  message.content.toLowerCase().includes(searchQuery.toLowerCase())
                )
                .map((message, index) => {
                  const originalIndex = messages.findIndex(m => m.id === message.id)
                  return (
                    <div key={message.id}>
                      {message.role === 'assistant' && message.plan && (
                        <AgentThinking isThinking={false} plan={message.plan} />
                      )}
                      {message.role === 'assistant' && message.webSearchResults && message.webSearchResults.length > 0 && (
                        <WebSearchResults results={message.webSearchResults} />
                      )}
                      {message.role === 'assistant' && message.toolsUsed && message.toolsUsed.map((tool, idx) => (
                        <ToolUsage key={idx} toolName={tool.name} toolResult={tool.result} />
                      ))}
                      <MessageBubble
                      message={message}
                      isEditing={editingMessageId === message.id}
                      editingContent={editingMessageContent}
                      onEditContentChange={setEditingMessageContent}
                      onSaveEdit={handleSaveEdit}
                      onCancelEdit={() => {
                        setEditingMessageId(null)
                        setEditingMessageContent('')
                      }}
                      onEdit={() => handleEditMessage(message.id)}
                      onDelete={() => handleDeleteMessage(message.id)}
                  onRegenerate={() => handleRegenerate(message.id)}
                  onCopy={handleCopyMessage}
                  onRetry={message.error ? () => handleRetry(message.id) : undefined}
                  canRegenerate={message.role === 'assistant' && originalIndex > 0 && messages[originalIndex - 1].role === 'user'}
                  isRegenerating={regeneratingMessageId === message.id}
                  highlightText={searchQuery}
                    />
                    </div>
                  )
                })}
              {isLoading && <TypingIndicator />}
              <div ref={messagesEndRef} />
            </div>
          )}
        </div>
      </div>

      {/* Upload Panel */}
      {showUploadPanel && (
        <div className="border-t border-[rgba(255,255,255,0.08)] bg-[#0a0a0f]/95 backdrop-blur-xl p-4">
          <div className="max-w-4xl mx-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-semibold text-sm">Add Source</h3>
              <button onClick={() => { setShowUploadPanel(false); setUploadType(null) }} className="text-[#64748b] hover:text-white">
                <X className="w-5 h-5" />
              </button>
            </div>

            {!uploadType ? (
              <div className="grid grid-cols-3 gap-3">
                <button
                  onClick={() => setUploadType('pdf')}
                  className="card card-interactive p-4 flex flex-col items-center gap-2"
                >
                  <div className="w-10 h-10 rounded-lg bg-rose-500/20 flex items-center justify-center">
                    <FileText className="w-5 h-5 text-rose-400" />
                  </div>
                  <span className="text-sm font-medium">PDF</span>
                </button>
                <button
                  onClick={() => setUploadType('url')}
                  className="card card-interactive p-4 flex flex-col items-center gap-2"
                >
                  <div className="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                    <Globe className="w-5 h-5 text-emerald-400" />
                  </div>
                  <span className="text-sm font-medium">Website</span>
                </button>
                <button
                  onClick={() => setUploadType('github')}
                  className="card card-interactive p-4 flex flex-col items-center gap-2"
                >
                  <div className="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <Github className="w-5 h-5 text-purple-400" />
                  </div>
                  <span className="text-sm font-medium">GitHub</span>
                </button>
              </div>
            ) : uploadType === 'pdf' ? (
              <div className="space-y-3">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".pdf"
                  onChange={handlePDFUpload}
                  className="hidden"
                />
                <button
                  onClick={() => fileInputRef.current?.click()}
                  disabled={uploading}
                  className="w-full card card-interactive p-6 border-dashed flex flex-col items-center gap-2"
                >
                  {uploading ? (
                    <Loader2 className="w-8 h-8 text-indigo-400 animate-spin" />
                  ) : (
                    <Upload className="w-8 h-8 text-rose-400" />
                  )}
                  <span className="text-sm">{uploading ? 'Uploading...' : 'Click to select PDF'}</span>
                </button>
                <button onClick={() => setUploadType(null)} className="text-sm text-[#64748b] hover:text-white">
                  Back
                </button>
              </div>
            ) : uploadType === 'url' ? (
              <div className="space-y-3">
                <input
                  type="url"
                  value={urlInput}
                  onChange={(e) => setUrlInput(e.target.value)}
                  placeholder="https://example.com/article"
                  className="w-full bg-[#15151f] border border-[rgba(255,255,255,0.1)] rounded-xl px-4 py-3 text-white placeholder-[#64748b] focus:border-indigo-500 outline-none"
                />
                <div className="flex gap-2">
                  <button onClick={() => setUploadType(null)} className="btn-ghost text-sm">
                    Back
                  </button>
                  <button
                    onClick={handleURLSubmit}
                    disabled={uploading || !urlInput.trim()}
                    className="btn-primary flex-1"
                  >
                    {uploading ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Add URL'}
                  </button>
                </div>
              </div>
            ) : (
              <div className="space-y-3">
                <input
                  type="url"
                  value={githubUrl}
                  onChange={(e) => setGithubUrl(e.target.value)}
                  placeholder="https://github.com/user/repo"
                  className="w-full bg-[#15151f] border border-[rgba(255,255,255,0.1)] rounded-xl px-4 py-3 text-white placeholder-[#64748b] focus:border-indigo-500 outline-none"
                />
                <input
                  type="text"
                  value={githubBranch}
                  onChange={(e) => setGithubBranch(e.target.value)}
                  placeholder="Branch (default: main)"
                  className="w-full bg-[#15151f] border border-[rgba(255,255,255,0.1)] rounded-xl px-4 py-3 text-white placeholder-[#64748b] focus:border-indigo-500 outline-none"
                />
                <div className="flex gap-2">
                  <button onClick={() => setUploadType(null)} className="btn-ghost text-sm">
                    Back
                  </button>
                  <button
                    onClick={handleGitHubSubmit}
                    disabled={uploading || !githubUrl.trim()}
                    className="btn-primary flex-1"
                  >
                    {uploading ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Add Repo'}
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Input */}
      <div className="border-t border-[rgba(255,255,255,0.08)] bg-[#0a0a0f]/80 backdrop-blur-xl p-4">
        <form onSubmit={handleSubmit} className="max-w-4xl mx-auto">
          <div className="glass rounded-2xl p-2 focus-within:border-indigo-500/50 transition-all">
            <div className="flex items-end gap-2">
              <button
                type="button"
                onClick={() => setShowUploadPanel(!showUploadPanel)}
                className={`p-3 rounded-xl transition-all ${showUploadPanel ? 'bg-indigo-500/20 text-indigo-400' : 'text-[#64748b] hover:text-white hover:bg-[rgba(255,255,255,0.05)]'}`}
                title="Add source"
              >
                <Plus className="w-5 h-5" />
              </button>
              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => {
                  setInput(e.target.value)
                  adjustTextareaHeight()
                }}
                onKeyDown={handleKeyDown}
                placeholder={sources.length === 0 ? 'Ask me anything! Add sources for cited answers...' : 'Ask anything about your sources...'}
                disabled={isLoading}
                rows={1}
                className="flex-1 bg-transparent resize-none outline-none text-white placeholder-[#64748b] px-2 py-3 max-h-40 min-h-[52px]"
              />
              <button
                type="submit"
                disabled={!input.trim() || isLoading}
                className="p-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg hover:shadow-indigo-500/25 transition-all"
              >
                {isLoading ? (
                  <Loader2 className="w-5 h-5 animate-spin" />
                ) : (
                  <Send className="w-5 h-5" />
                )}
              </button>
            </div>
          </div>
          <p className="text-xs text-[#64748b] mt-2 text-center">
            Press Enter to send, Shift + Enter for new line â€¢ Ctrl/Cmd + K to focus â€¢ Ctrl/Cmd + N for new chat â€¢ Ctrl/Cmd + F to search â€¢ Ctrl/Cmd + E to export
          </p>
        </form>
      </div>
    </div>
  )
}

function WelcomeScreen({ sources, sourcesLoading, onAddSource }: { sources: Source[]; sourcesLoading: boolean; onAddSource: () => void }) {
  return (
    <div className="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
      <div className="relative mb-8">
        <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center animate-float">
          <Sparkles className="w-10 h-10 text-white" />
        </div>
        <div className="absolute inset-0 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 blur-2xl opacity-40" />
      </div>

      <h2 className="text-2xl md:text-3xl font-bold mb-4">
        <span className="gradient-text">Ask Anything</span>
      </h2>

      <p className="text-[#94a3b8] max-w-md mb-8">
        {sourcesLoading
          ? 'Loading your sources...'
          : sources.length === 0
          ? 'Start chatting! Add sources like GitHub repos, PDFs, or URLs for answers with citations.'
          : `You have ${sources.length} source${sources.length > 1 ? 's' : ''} loaded. Ask me anything!`
        }
      </p>

      {!sourcesLoading && sources.length === 0 && (
        <div className="flex gap-3">
          <button onClick={onAddSource} className="btn-primary">
            <Plus className="w-4 h-4" />
            Add Source
          </button>
        </div>
      )}

      {!sourcesLoading && sources.length > 0 && (
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-2xl w-full">
          {[
            { icon: 'ðŸ“š', title: 'Learn Faster', desc: 'Get instant answers from your materials' },
            { icon: 'ðŸ”', title: 'Find Citations', desc: 'Every answer includes source references' },
            { icon: 'ðŸ’¡', title: 'Ask Anything', desc: 'Code, concepts, or implementation details' },
          ].map((item, i) => (
            <div key={i} className="card text-left">
              <div className="text-3xl mb-3">{item.icon}</div>
              <h3 className="font-semibold text-white mb-1">{item.title}</h3>
              <p className="text-sm text-[#94a3b8]">{item.desc}</p>
            </div>
          ))}
        </div>
      )}
    </div>
  )
}

interface MessageBubbleProps {
  message: Message
  isEditing?: boolean
  editingContent?: string
  onEditContentChange?: (content: string) => void
  onSaveEdit?: () => void
  onCancelEdit?: () => void
  onEdit?: () => void
  onDelete?: () => void
  onRegenerate?: () => void
  onCopy?: (content: string) => void
  onRetry?: () => void
  canRegenerate?: boolean
  isRegenerating?: boolean
  highlightText?: string
}

function MessageBubble({
  message,
  isEditing = false,
  editingContent = '',
  onEditContentChange,
  onSaveEdit,
  onCancelEdit,
  onEdit,
  onDelete,
  onRegenerate,
  onCopy,
  onRetry,
  canRegenerate = false,
  isRegenerating = false,
  highlightText = ''
}: MessageBubbleProps) {
  const isUser = message.role === 'user'
  const [showCitations, setShowCitations] = useState(false)
  const [showActions, setShowActions] = useState(false)

  if (message.error) {
    return (
      <div className="flex gap-4 fade-in">
        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-rose-600 flex items-center justify-center flex-shrink-0">
          <X className="w-5 h-5 text-white" />
        </div>
        <div className="flex-1 max-w-[80%]">
          <div className="inline-block rounded-2xl px-5 py-3 bg-red-500/10 border border-red-500/30">
            <div className="flex items-center gap-2 mb-2">
              <span className="text-red-400 font-semibold text-sm">Error</span>
            </div>
            <p className="text-red-300 text-sm mb-3">{message.errorMessage || 'An error occurred'}</p>
            {onRetry && (
              <button
                onClick={onRetry}
                className="text-xs px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg transition-colors text-red-300"
              >
                Retry
              </button>
            )}
          </div>
        </div>
      </div>
    )
  }

  const highlightTextInContent = (content: string, query: string) => {
    if (!query) return content
    const parts = content.split(new RegExp(`(${query})`, 'gi'))
    return parts.map((part, i) => 
      part.toLowerCase() === query.toLowerCase() ? (
        <mark key={i} className="bg-yellow-500/30 text-yellow-200">{part}</mark>
      ) : (
        part
      )
    )
  }

  return (
    <div className={`flex gap-4 fade-in group ${isUser ? 'flex-row-reverse' : ''}`}>
      {/* Avatar */}
      <div
        className={`flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center ${
          isUser
            ? 'bg-gradient-to-br from-cyan-500 to-blue-600'
            : 'bg-gradient-to-br from-purple-500 to-pink-600'
        }`}
      >
        {isUser ? <User className="w-5 h-5 text-white" /> : <Bot className="w-5 h-5 text-white" />}
      </div>

      {/* Message */}
      <div className={`flex-1 max-w-[80%] ${isUser ? 'text-right' : ''}`}>
        <div className="relative">
          {isEditing ? (
            <div className="rounded-2xl px-5 py-3 message-user">
              <textarea
                value={editingContent}
                onChange={(e) => onEditContentChange?.(e.target.value)}
                className="w-full bg-transparent text-white resize-none outline-none"
                rows={3}
                autoFocus
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault()
                    onSaveEdit?.()
                  }
                  if (e.key === 'Escape') {
                    onCancelEdit?.()
                  }
                }}
              />
              <div className="flex gap-2 mt-2">
                <button
                  onClick={onSaveEdit}
                  className="text-xs px-3 py-1 bg-indigo-500 hover:bg-indigo-600 rounded-lg transition-colors"
                >
                  Save
                </button>
                <button
                  onClick={onCancelEdit}
                  className="text-xs px-3 py-1 bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.2)] rounded-lg transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <>
              <div
                className={`inline-block rounded-2xl px-5 py-3 relative ${
                  isUser ? 'message-user text-white' : 'message-ai text-white/90'
                }`}
                onMouseEnter={() => setShowActions(true)}
                onMouseLeave={() => setShowActions(false)}
              >
                {isUser ? (
                  <p className="whitespace-pre-wrap">
                    {highlightText ? highlightTextInContent(message.content, highlightText) : message.content}
                  </p>
                ) : (
                  <div className="prose prose-invert prose-sm max-w-none text-left">
                    <ReactMarkdown
                      components={{
                        code({ node, inline, className, children, ...props }: any) {
                          const match = /language-(\w+)/.exec(className || '')
                          return !inline && match ? (
                            <SyntaxHighlighter
                              style={vscDarkPlus}
                              language={match[1]}
                              PreTag="div"
                              className="rounded-lg"
                              {...props}
                            >
                              {String(children).replace(/\n$/, '')}
                            </SyntaxHighlighter>
                          ) : (
                            <code className={className} {...props}>
                              {children}
                            </code>
                          )
                        },
                        p: ({ children }: any) => {
                          const content = String(children)
                          return highlightText ? (
                            <p>{highlightTextInContent(content, highlightText)}</p>
                          ) : (
                            <p>{children}</p>
                          )
                        }
                      }}
                    >
                      {message.content}
                    </ReactMarkdown>
                  </div>
                )}

                {/* Message Actions */}
                {showActions && (
                  <div className={`absolute top-2 ${isUser ? 'left-2' : 'right-2'} flex gap-1 bg-[#0a0a0f]/90 backdrop-blur-sm rounded-lg p-1 border border-[rgba(255,255,255,0.1)]`}>
                    {onCopy && (
                      <button
                        onClick={() => onCopy(message.content)}
                        className="p-1.5 rounded hover:bg-[rgba(255,255,255,0.1)] transition-colors"
                        title="Copy"
                      >
                        <Copy className="w-3.5 h-3.5" />
                      </button>
                    )}
                    {isUser && onEdit && (
                      <button
                        onClick={onEdit}
                        className="p-1.5 rounded hover:bg-[rgba(255,255,255,0.1)] transition-colors"
                        title="Edit"
                      >
                        <Edit2 className="w-3.5 h-3.5" />
                      </button>
                    )}
                    {!isUser && canRegenerate && onRegenerate && (
                      <button
                        onClick={onRegenerate}
                        disabled={isRegenerating}
                        className="p-1.5 rounded hover:bg-[rgba(255,255,255,0.1)] transition-colors disabled:opacity-50"
                        title="Regenerate"
                      >
                        <RotateCcw className={`w-3.5 h-3.5 ${isRegenerating ? 'animate-spin' : ''}`} />
                      </button>
                    )}
                    {onDelete && (
                      <button
                        onClick={onDelete}
                        className="p-1.5 rounded hover:bg-red-500/20 text-red-400 transition-colors"
                        title="Delete"
                      >
                        <Trash2 className="w-3.5 h-3.5" />
                      </button>
                    )}
                  </div>
                )}
              </div>
            </>
          )}
        </div>

        {/* Citations */}
        {!isUser && message.citations && message.citations.length > 0 && (
          <div className="mt-3 text-left">
            <button
              onClick={() => setShowCitations(!showCitations)}
              className="flex items-center gap-2 text-xs text-indigo-400 hover:text-indigo-300 transition-colors group"
            >
              <FileCode className="w-4 h-4 group-hover:scale-110 transition-transform" />
              <span className="font-medium">
                {message.citations.length} citation{message.citations.length > 1 ? 's' : ''}
              </span>
              <ChevronDown className={`w-4 h-4 transition-transform ${showCitations ? 'rotate-180' : ''}`} />
            </button>

            {showCitations && (
              <div className="mt-3 space-y-2 animate-in fade-in slide-in-from-top-2">
                {message.citations.map((citation, i) => (
                  <div
                    key={i}
                    className="citation-card group/citation bg-[rgba(99,102,241,0.05)] border border-indigo-500/20 rounded-lg p-3 hover:border-indigo-500/40 transition-all"
                  >
                    <div className="flex items-start justify-between gap-2 mb-2">
                      <div className="flex items-center gap-2 flex-1 min-w-0">
                        <div className="flex-shrink-0 w-6 h-6 rounded bg-indigo-500/20 flex items-center justify-center text-xs font-semibold text-indigo-400">
                          {i + 1}
                        </div>
                        <div className="min-w-0 flex-1">
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-xs font-semibold text-indigo-300 truncate">
                              {citation.source}
                            </span>
                            {citation.line && (
                              <span className="text-xs text-[#94a3b8] bg-[rgba(255,255,255,0.05)] px-2 py-0.5 rounded">
                                Line {citation.line}
                              </span>
                            )}
                            {citation.page && (
                              <span className="text-xs text-[#94a3b8] bg-[rgba(255,255,255,0.05)] px-2 py-0.5 rounded">
                                Page {citation.page}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                      <button
                        onClick={() => onCopy?.(citation.content)}
                        className="opacity-0 group-hover/citation:opacity-100 transition-opacity p-1 hover:bg-[rgba(255,255,255,0.1)] rounded"
                        title="Copy citation"
                      >
                        <Copy className="w-3 h-3" />
                      </button>
                    </div>
                    <div className="pl-8">
                      <p className="text-xs text-[#94a3b8] leading-relaxed line-clamp-3 group-hover/citation:line-clamp-none transition-all">
                        {citation.content}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Timestamp */}
        <p className={`text-xs text-[#64748b] mt-2 ${isUser ? 'text-right' : ''}`}>
          {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
        </p>
      </div>
    </div>
  )
}

function TypingIndicator() {
  return (
    <div className="flex gap-4 fade-in">
      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
        <Bot className="w-5 h-5 text-white" />
      </div>
      <div className="message-ai rounded-2xl">
        <div className="typing-indicator">
          <span />
          <span />
          <span />
        </div>
      </div>
    </div>
  )
}
